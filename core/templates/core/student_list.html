{% extends "base.html" %}

{% block title %}Alumnos · Moodle Notifier{% endblock %}
{% block page_title %}Alumnos{% endblock %}
{% block page_subtitle %}Gestión de alumnos y estado en Moodle.{% endblock %}

{% block content %}

<!-- HEADER LISTA -->
<div class="flex justify-between items-center mb-6">
  <h2 class="text-sm font-semibold text-gray-800">Listado de alumnos</h2>

  <a href="{% url 'student_create' %}"
     class="text-xs px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-gray-700 transition">
    + Nuevo alumno
  </a>
</div>

<!-- FILTROS -->
<div class="flex items-center gap-3 mb-5">

  <a href="{% url 'student_list' %}{% if q %}?q={{ q }}{% endif %}"
     class="px-3 py-1 text-xs rounded-lg border {% if not estado %}bg-gray-900 text-white{% else %}bg-white text-gray-700{% endif %}">
    Todos
  </a>

  <a href="?estado=interno{% if q %}&q={{ q }}{% endif %}"
     class="px-3 py-1 text-xs rounded-lg border {% if estado == 'interno' %}bg-yellow-500 text-white{% else %}bg-white text-gray-700{% endif %}">
    Interno
  </a>

  <a href="?estado=moodle{% if q %}&q={{ q }}{% endif %}"
     class="px-3 py-1 text-xs rounded-lg border {% if estado == 'moodle' %}bg-green-500 text-white{% else %}bg-white text-gray-700{% endif %}">
    Moodle creado
  </a>

  <a href="?estado=matriculado{% if q %}&q={{ q }}{% endif %}"
     class="px-3 py-1 text-xs rounded-lg border {% if estado == 'matriculado' %}bg-blue-500 text-white{% else %}bg-white text-gray-700{% endif %}">
    Matriculados
  </a>

</div>

<!-- BUSCADOR -->
<form method="get" class="mb-5 flex flex-col md:flex-row items-start md:items-center gap-3">
  {% if estado %}
    <input type="hidden" name="estado" value="{{ estado }}">
  {% endif %}
  <input
    type="text"
    name="q"
    value="{{ q }}"
    placeholder="Buscar por nombre, email o DNI"
    class="w-full md:w-80 rounded-lg border border-gray-300 px-3 py-2 text-xs focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
  />
  <div class="flex gap-2">
    <button type="submit" class="px-4 py-2 text-xs font-semibold rounded-lg bg-gray-900 text-white hover:bg-gray-700 transition">
      Buscar
    </button>
    {% if q %}
      <a href="{% url 'student_list' %}{% if estado %}?estado={{ estado }}{% endif %}"
         class="px-4 py-2 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition">
        Limpiar
      </a>
    {% endif %}
  </div>
</form>


<!-- TABLA -->
<div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
  <table class="w-full text-xs">
    <thead class="bg-gray-50 text-gray-600 border-b font-semibold">
      <tr>
        <th class="text-left px-5 py-3">Nombre</th>
        <th class="text-left px-5 py-3">Email</th>
        <th class="text-left px-5 py-3">Estado</th>
        <th class="text-left px-5 py-3">Cursos</th>
        <th class="text-left px-5 py-3">Creado</th>
        <th class="text-right px-5 py-3">Acciones</th>
      </tr>
    </thead>

    <tbody class="text-gray-800">
      {% for student in students %}
      <tr class="border-b last:border-0 hover:bg-gray-50 transition">

        <!-- NOMBRE -->
        <td class="px-5 py-3">
          <a href="{% url 'student_detail' student.id %}"
             class="text-blue-600 font-medium hover:underline">
            {{ student.first_name }} {{ student.last_name }}
          </a>
        </td>

        <!-- EMAIL -->
        <td class="px-5 py-3 text-gray-700">
          {{ student.email }}
        </td>

        <!-- ESTADO -->
        <td class="px-5 py-3">
          {% if not student.moodle_user_id %}
            <span class="px-2 py-1 text-[10px] font-semibold rounded bg-yellow-100 text-yellow-700">
              Interno
            </span>

          {% elif student.course_count == 0 %}
            <span class="px-2 py-1 text-[10px] font-semibold rounded bg-green-100 text-green-700">
              Moodle ID: {{ student.moodle_user_id }}
            </span>

          {% else %}
            <span class="px-2 py-1 text-[10px] font-semibold rounded bg-blue-100 text-blue-700">
              Matriculado
            </span>
          {% endif %}
        </td>

        <!-- CURSOS ASIGNADOS -->
        <td class="px-5 py-3 text-gray-700">
          {% if student.course_count > 0 %}
            <span class="font-medium">{{ student.course_count }}</span>
          {% else %}
            <span class="text-gray-400">0</span>
          {% endif %}
        </td>

        <!-- FECHA -->
        <td class="px-5 py-3 text-gray-500">
          {{ student.created_at|date:"d/m/Y H:i" }}
        </td>

        <!-- ACCIONES -->
        <td class="px-5 py-3 text-right space-x-3">
          <a href="{% url 'student_detail' student.id %}" class="text-blue-600 hover:underline">Ver</a>
          <a href="{% url 'student_edit' student.id %}" class="text-gray-700 hover:underline">Editar</a>
          <a href="{% url 'student_delete' student.id %}"
             class="inline-block px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 transition">
            Eliminar
          </a>
        </td>

      </tr>

      {% empty %}
      <tr>
        <td colspan="6" class="px-5 py-8 text-center text-gray-500">
          No hay alumnos registrados todavía.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- PAGINACIÓN -->
{% if page_obj %}
<div class="flex justify-center items-center mt-6 gap-2">

  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if estado %}&estado={{ estado }}{% endif %}{% if q %}&q={{ q }}{% endif %}"
       class="px-3 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300">Anterior</a>
  {% endif %}

  <span class="text-xs text-gray-600 px-3 py-1">
    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
  </span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if estado %}&estado={{ estado }}{% endif %}{% if q %}&q={{ q }}{% endif %}"
       class="px-3 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300">Siguiente</a>
  {% endif %}

</div>
{% endif %}

{% endblock %}
